# Copyright (C) 2025 Huawei Device Co., Ltd.
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#	http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
import("//build/test.gni")
import("../../../../test_template.gni")
import("../adlt_common.gni")
import("test_src_adlt_tsan.gni")

group("adlt_tsan_test") {
    testonly = true
    deps = []

    foreach(s, adlt_tsan_test) {
        deps += [ ":${s}" ]
    }
}

config("post_lib_configs") {
    cflags_cc = [ "-fsanitize=thread", "-O0" ]
    ldflags = [ "-Wl,--unresolved-symbols=ignore-all" ]
}

adlt_executable("unittest_adlt_tsan_data_race") {
    lib_name = "tsan_data_race"
    lib_configs = [
        {
            name = "tsan_data_race_a"
            include_dirs = [ "data-race" ]
            sources = ["data-race/a.cpp"]
        },
    ]

    sources = [ "data-race/main.cpp" ]
    ldflags = [ "-Wl,$adlt_abs_runtime_clang_path/libclang_rt.tsan.a" ]

    lib_common_configs = [
        ":post_lib_configs"
    ]
}

adlt_executable("unittest_adlt_tsan_data_race_two_libs") {
    lib_name = "tsan_data_race_two_libs"
    lib_include_dirs = [ "data-race-two-libs" ]
    lib_configs = [
        {
            name = "tsan_data_race_two_libs_a"
            sources = ["data-race-two-libs/a.cpp"]
        },
        {
            name = "tsan_data_race_two_libs_b"
            sources = ["data-race-two-libs/b.cpp"]
        },
    ]

    sources = [ "data-race-two-libs/main.cpp" ]
    ldflags = [ "-Wl,$adlt_abs_runtime_clang_path/libclang_rt.tsan.a" ]

    lib_common_configs = [
        ":post_lib_configs"
    ]
}